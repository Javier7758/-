<script>
    const { createApp, ref, computed, watch } = Vue;

    // =======================================================
    // ðŸš© ä½ çš„ Firebase Config (è«‹å‹™å¿…æ›¿æ›ç‚ºä½ å°ˆå±¬çš„é‡‘é‘°ï¼) ðŸš©
    // =======================================================
    const firebaseConfig = {
        apiKey: "AIzaSyDVWuYmV0Cp3REPJ-gIybjNjTtdLW0mST8", 
        authDomain: "project-8464896306397913259.firebaseapp.com",
        projectId: "project-8464896306397913259",
        storageBucket: "project-8464896306397913259.firebasestorage.app",
        messagingSenderId: "647207538830",
        appId: "1:647207538830:web:d1d5447961c615334179df", 
        measurementId: "G-VM8SF4Q9HE" 
    };

    // é—œéµè®Šæ•¸ï¼šç¾¤çµ„ ID
    const GROUP_ID = "HK2026_TRIP"; 

    // åˆå§‹åŒ– Firebase å’Œæœå‹™
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // å„²å­˜è³‡æ–™çš„é è¨­çµæ§‹
    const defaultData = {
        schedule: [
            { id: 1, date: '12/25', tag: 'å•Ÿç¨‹', desc: 'æŠµæ¸¯ã€check-in', isEditing: false },
        ],
        landmarks: [
            { id: 1, name: 'é¦™æ¸¯è¿ªå£«å°¼æ¨‚åœ’', type: 'éŠæ¨‚æ™¯é»ž', desc: 'é è¨ˆ 1/2', isEditing: false },
        ],
        expenses: [{ item: 'æ©Ÿç¥¨', amount: 8000, method: 'ä¿¡ç”¨å¡' }],
        wishlist: [{ id: 1, member: 'æ©žå®œ', item: 'å°ç†Šç¶­å°¼å…¬ä»”', done: false }],
    };

    // =======================================================
    // ðŸš© æ ¸å¿ƒåŒæ­¥é‚è¼¯ (å…¨å“¡å¯è®€å¯«) ðŸš©
    // =======================================================

    function loadAllDataFromFirestore() {
        // ... (æ­¤å‡½å¼å…§å®¹ä¿æŒä¸è®Š) ...
        db.collection('groups').doc(GROUP_ID).get()
            .then((doc) => {
                const data = doc.exists ? doc.data() : defaultData;
                
                schedule.value = data.schedule.map(item => ({ ...item, isEditing: false }));
                const maxSId = schedule.value.length > 0 ? Math.max(...schedule.value.map(s => s.id)) : 0;
                nextScheduleId = maxSId + 1;

                landmarks.value = data.landmarks.map(item => ({ ...item, isEditing: false }));
                const maxLId = landmarks.value.length > 0 ? Math.max(...landmarks.value.map(l => l.id)) : 0;
                nextLandmarkId = maxLId + 1;
                
                expenses.value = data.expenses || [];
                
                wishlist.value = data.wishlist || [];
                const maxWId = wishlist.value.length > 0 ? Math.max(...wishlist.value.map(w => w.id)) : 0;
                nextWishId = maxWId + 1;

                console.log("âœ… è³‡æ–™å¾ž Firestore è¼‰å…¥æˆåŠŸï¼");
            })
            .catch(error => {
                console.error("è®€å– Firestore å¤±æ•—:", error);
            });
    }

    function saveAllDataToFirestore() {
        if (!user.value) { return; }
        
        const cleanSchedule = schedule.value.map(({ isEditing, ...rest }) => rest);
        const cleanLandmarks = landmarks.value.map(({ isEditing, ...rest }) => rest);

        db.collection('groups').doc(GROUP_ID).set({
            schedule: cleanSchedule,
            landmarks: cleanLandmarks,
            expenses: expenses.value, 
            wishlist: wishlist.value
        }, { merge: true }) 
        .then(() => {
            console.log("ðŸ’¾ è³‡æ–™åŒæ­¥åˆ°é›²ç«¯æˆåŠŸï¼");
        })
        .catch((error) => {
            console.error("å¯«å…¥ Firestore å¤±æ•—:", error);
        });
    }

    // -------------------------------------------------------
    // Vue App å•Ÿå‹•é‚è¼¯ 
    // -------------------------------------------------------

    let nextScheduleId = 4;
    let nextLandmarkId = 4;
    let nextWishId = 2; 

    // ðŸš© æ–°çš„å•Ÿå‹•å‡½æ•¸ï¼šå„ªå…ˆæª¢æŸ¥ç”¨æˆ¶ï¼Œå¦å‰‡ç›´æŽ¥åŒ¿åç™»å…¥ ðŸš©
    function initializeApp(userRef, loadFunc) {
        // 1. æª¢æŸ¥æ˜¯å¦æœ‰ç¾æœ‰ç”¨æˆ¶ï¼ˆä¾‹å¦‚ä¸Šæ¬¡åŒ¿åç™»å…¥çš„ç´€éŒ„ï¼‰
        if (auth.currentUser) {
             userRef.value = auth.currentUser;
             loadFunc();
        } else {
            // 2. å¦‚æžœæ²’æœ‰ï¼Œç›´æŽ¥è§¸ç™¼åŒ¿åç™»å…¥ï¼Œç„¡éœ€ç­‰å¾… onAuthStateChanged
            auth.signInAnonymously()
                .then((result) => {
                    userRef.value = result.user;
                    loadFunc();
                })
                .catch((error) => {
                    console.error("è‡ªå‹•åŒ¿åç™»å…¥å¤±æ•—:", error);
                });
        }
    }


    createApp({
        setup() {
            const currentTab = ref('itinerary'); 
            const user = ref(null); 
            const isLoggedIn = computed(() => user.value !== null);
            
            // æ›¿æ›åŽŸæœ¬çš„ onAuthStateChanged ç›£è½
            initializeApp(user, loadAllDataFromFirestore);

            // --- æ•¸æ“šçµæ§‹ (Ref) ---
            const schedule = ref([]);
            const newScheduleItem = ref({ date: '', tag: '', desc: '' });
            const landmarks = ref([]);
            const newLandmarkItem = ref({ name: '', type: '', desc: '' });
            const expenses = ref([]);
            const newExpense = ref({ item: '', amount: null, method: 'ç¾é‡‘' });
            const members = ['çˆ¸çˆ¸', 'åª½åª½', 'æ©žå®œ', 'æŸå‘ˆ', 'å”æ²›'];
            const wishlist = ref([]);
            const selectedMember = ref('å…¨éƒ¨'); 
            const newWishItem = ref({ member: 'æ©žå®œ', item: '' }); 

            // æ•¸æ“šè®Šå‹•ç›£è½å™¨
            const watchOptions = { deep: true };
            watch(schedule, () => { if (isLoggedIn.value) saveAllDataToFirestore(); }, watchOptions);
            watch(landmarks, () => { if (isLoggedIn.value) saveAllDataToFirestore(); }, watchOptions);
            watch(expenses, () => { if (isLoggedIn.value) saveAllDataToFirestore(); }, watchOptions);
            watch(wishlist, () => { if (isLoggedIn.value) saveAllDataToFirestore(); }, watchOptions);


            // --- CRUD å‡½å¼ (å…§å®¹èˆ‡å…ˆå‰ç›¸åŒ) ---
            
            function addScheduleItem() {
                if (newScheduleItem.value.date && newScheduleItem.value.desc && isLoggedIn.value) {
                    schedule.value.push({
                        id: nextScheduleId++,
                        date: newScheduleItem.value.date,
                        tag: newScheduleItem.value.tag || 'è¡Œç¨‹',
                        desc: newScheduleItem.value.desc,
                        isEditing: false
                    });
                    newScheduleItem.value = { date: '', tag: '', desc: '' };
                }
            }

            function toggleEdit(item) { if(isLoggedIn.value) item.isEditing = !item.isEditing; }
            function deleteScheduleItem(id) { 
                if(isLoggedIn.value) schedule.value = schedule.value.filter(item => item.id !== id);
            }

            function addLandmarkItem() {
                if (newLandmarkItem.value.name && isLoggedIn.value) {
                    landmarks.value.push({
                        id: nextLandmarkId++,
                        name: newLandmarkItem.value.name,
                        type: newLandmarkItem.value.type || 'æ™¯é»ž',
                        desc: newLandmarkItem.value.desc || '',
                        isEditing: false
                    });
                    newLandmarkItem.value = { name: '', type: '', desc: '' };
                }
            }
            function toggleLandmarkEdit(item) { if(isLoggedIn.value) item.isEditing = !item.isEditing; }
            function deleteLandmarkItem(id) { 
                if(isLoggedIn.value) landmarks.value = landmarks.value.filter(item => item.id !== id);
            }

            const totalExpense = computed(() => expenses.value.reduce((sum, exp) => sum + exp.amount, 0));
            function addExpense() {
                if (newExpense.value.item && newExpense.value.amount && isLoggedIn.value) {
                    expenses.value.unshift({ ...newExpense.value });
                    newExpense.value = { item: '', amount: null, method: 'ç¾é‡‘' };
                }
            }

            const filteredWishlist = computed(() => {
                if (selectedMember.value === 'å…¨éƒ¨') {
                    return [...wishlist.value].sort((a, b) => members.indexOf(a.member) - members.indexOf(b.member));
                }
                return wishlist.value.filter(item => item.member === selectedMember.value);
            });
            
            function addWishItem() {
                if (newWishItem.value.item && newWishItem.value.member && isLoggedIn.value) {
                    wishlist.value.push({ 
                        id: nextWishId++,
                        member: newWishItem.value.member,
                        item: newWishItem.value.item, 
                        done: false 
                    });
                    newWishItem.value.item = ''; 
                    selectedMember.value = newWishItem.value.member;
                }
            }
            
            function deleteWishItem(id) {
                if (isLoggedIn.value) {
                    wishlist.value = wishlist.value.filter(item => item.id !== id);
                }
            }


            return { 
                currentTab, user, isLoggedIn,
                // è¡Œç¨‹
                schedule, newScheduleItem, addScheduleItem, toggleEdit, deleteScheduleItem,
                // æ™¯é»ž
                landmarks, newLandmarkItem, addLandmarkItem, toggleLandmarkEdit, deleteLandmarkItem,
                // è¨˜å¸³
                expenses, newExpense, totalExpense, addExpense, 
                // é¡˜æœ›æ¸…å–®
                members, selectedMember, wishlist, filteredWishlist, newWishItem, addWishItem, deleteWishItem
            };
        }
    }).mount('#app');
</script>