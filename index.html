<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025-2026 è·¨å¹´æ—…è¡Œ | é›²ç«¯åŒæ­¥ç‰ˆ</title>
   <link rel="apple-touch-icon" sizes="180x180" href="./aicon.png">

    <link rel="icon" type="image/png" sizes="192x192" href="./aicon.png">
    <link rel="icon" type="image/png" sizes="512x512" href="./aicon.png">
    
    <link rel="shortcut icon" href="./aicon.png">
    <link rel="manifest" href="./manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .tab-active { color: #ff0000; border-bottom: 2px solid #ff0000; }
        .fa-solid { margin-right: 5px; } 

       /* ã€é¦™æ¸¯èƒŒæ™¯ï¼šä½¿ç”¨è‡ªå·±çš„åœ–ç‰‡ã€‘ */
        .card-bg-HK { 
            background: linear-gradient(rgba(88, 28, 135, 0.4), rgba(0, 0, 0, 0.6)), /* ç´«è‰²æ¿¾é¡ */
            url('./hk.jpg'); 
            background-size: cover; 
            background-position: center;
        }
        
        /* ã€æ·±åœ³èƒŒæ™¯ï¼šä½¿ç”¨è‡ªå·±çš„åœ–ç‰‡ã€‘ */
        .card-bg-SZ { 
            background: linear-gradient(rgba(6, 78, 59, 0.4), rgba(0, 0, 0, 0.6)), /* ç¶ è‰²æ¿¾é¡ */
            url('./sz.jpg'); 
            background-size: cover; 
            background-position: center;
        }

        /* ã€å»£å·èƒŒæ™¯ï¼šä½¿ç”¨è‡ªå·±çš„åœ–ç‰‡ã€‘ */
        .card-bg-GZ { 
            background: linear-gradient(rgba(30, 64, 175, 0.4), rgba(0, 0, 0, 0.6)), /* è—è‰²æ¿¾é¡ */
            url('./gz.jpg'); 
            background-size: cover; 
            background-position: center;
        }

        .card-bg-default {
            background-color: #374151; /* slate-700 fallback */
        }
        
        .weather-info {
            display: flex;
            align-items: center;
            font-size: 0.8rem;
            text-align: right;
            margin-left: auto;
            padding-left: 8px; 
        }

        /* æ™¯é»é€£çµæ¨£å¼ */
        .detail-link {
            font-weight: bold;
            color: #1a73e8; /* è—è‰² */
            transition: color 0.15s;
        }
        .detail-link:hover {
            color: #0056b3;
            text-decoration: underline;
        }
        [v-cloak] { display: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="app" v-cloak class="max-w-md mx-auto min-h-screen pb-4 relative shadow-2xl bg-white">
        
        <header class="bg-slate-900 text-white p-4 rounded-b-3xl shadow-lg">
            <div class="flex justify-between items-start mb-1">
                <div>
                    <h1 class="text-xl font-bold italic">è·¨å¹´æ—…è¡Œ <span class="text-orange-500">2025-2026</span></h1>
                    
                    <p class="text-xs opacity-75 flex items-center">
                        <span v-if="dbStatus === 'å·²é€£ç·š'" class="text-green-400 mr-2"><i class="fa-solid fa-cloud"></i> é›²ç«¯å·²é€£ç·šåŠåŒæ­¥</span>
                        <span v-else class="text-yellow-400 mr-2"><i class="fa-solid fa-spinner fa-spin"></i> {{ dbStatus }}</span>
                    </p>

                    <p class="text-[10px] text-green-300 flex items-center mt-1 font-mono tracking-wide">
                        <span class="relative flex h-2 w-2 mr-2">
                          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                          <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                        </span>
                        {{ onlineCount }} äººåœ¨ç·šä¸­
                    </p>
                </div>
                
                <div class="text-right text-sm">
                    <p class="font-bold text-orange-400">{{ currentFullDate }}</p>
                    <p class="font-light text-xl leading-none">{{ currentTime }}</p>
                    
                    <div v-if="localWeather" class="flex justify-end items-center text-xs text-blue-200 mt-1 font-bold animate-pulse">
                        <i class="fa-solid fa-location-dot mr-1 text-orange-400"></i>
                        <span>{{ localWeather.city }} | {{ localWeather.weather }} {{ localWeather.temp }}</span>
                    </div>

                    <div v-if="todayHeaderWeather" class="flex items-center justify-end opacity-90 mt-1 space-x-1">
                        <i :class="getWeatherIcon(todayHeaderWeather.weather)" class="fa-solid text-yellow-300 text-sm"></i>
                        <span class="text-xs font-medium">{{ todayHeaderWeather.weather }}</span>
                        <span class="text-xs opacity-75">({{ todayHeaderWeather.city }})</span>
                    </div>
                    <div v-else class="h-4"></div> 
                </div>
            </div>
        </header>
        
        <nav class="flex justify-around bg-white border-b sticky top-0 z-10 text-slate-400 font-medium overflow-x-auto">
            <button @click="currentTab = 'itinerary'" :class="{'tab-active': currentTab === 'itinerary'}" class="py-4 flex-1 text-sm whitespace-nowrap px-2"><i class="fa-solid fa-calendar-days block text-lg mb-1"></i>è¡Œç¨‹</button>
            <button @click="currentTab = 'finance'" :class="{'tab-active': currentTab === 'finance'}" class="py-4 flex-1 text-sm whitespace-nowrap px-2"><i class="fa-solid fa-wallet block text-lg mb-1"></i>è¨˜å¸³</button>
            <button @click="currentTab = 'wishlist'" :class="{'tab-active': currentTab === 'wishlist'}" class="py-4 flex-1 text-sm whitespace-nowrap px-2"><i class="fa-solid fa-gift block text-lg mb-1"></i>é¡˜æœ›</button>
            
            <a href="https://www.gbaweather.net/tc/" target="_blank" class="py-4 flex-1 text-sm flex flex-col items-center justify-center text-slate-400 hover:text-orange-500 transition duration-150">
                <i class="fa-solid fa-cloud-sun block text-lg mb-1"></i>
                å¤©æ°£
            </a>
            
            <button @click="currentTab = 'essentials'" :class="{'tab-active': currentTab === 'essentials'}" class="py-4 flex-1 text-sm whitespace-nowrap px-2"><i class="fa-solid fa-bell block text-lg mb-1"></i>é‡è¦è³‡è¨Š</button>
        </nav>

        <main class="p-4">
            
            <section v-if="currentTab === 'itinerary'" class="space-y-4">
                
                <div class="bg-slate-200 p-4 rounded-2xl mb-4 shadow-inner">
                    <h3 class="font-bold text-slate-800 mb-2 flex justify-between items-center">
                        åŒ¯ç‡è¨ˆç®—æ©Ÿ (TWD) <i class="fa-solid fa-calculator"></i>
                    </h3>
                    <div class="flex gap-2 mb-3">
                        <input v-model.number="calculator.amount" type="number" placeholder="è¼¸å…¥é‡‘é¡" class="w-1/2 p-3 border rounded-xl text-sm focus:ring-orange-500 focus:border-orange-500">
                        <select v-model="calculator.currency" class="w-1/2 p-3 border rounded-xl text-sm bg-white">
                            <option value="HKD">HKD (æ¸¯å¹£1:4)</option>
                            <option value="RMB">RMB (äººæ°‘å¹£1:4.4)</option>
                        </select>
                    </div>
                    <p v-if="calculator.amount > 0" class="text-center text-lg font-bold text-orange-700">
                        = ${{ calculatedTWD.toFixed(2) }} TWD
                    </p>
                    <p v-else class="text-center text-sm text-slate-500">
                        è«‹è¼¸å…¥é‡‘é¡ä»¥é–‹å§‹è¨ˆç®—
                    </p>
                </div>

                <button @click="showEarlyTrip = !showEarlyTrip" 
                    class="w-full py-2 bg-slate-100 text-slate-500 text-sm font-bold rounded-xl border border-dashed border-slate-300 hover:bg-slate-200 transition">
                    <i class="fa-solid" :class="showEarlyTrip ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                    {{ showEarlyTrip ? 'æ”¶èµ·' : 'å±•é–‹' }} 12/25 - 12/31 è¡Œç¨‹
                </button>

                <div v-for="day in orderedSchedule" :key="day.id" 
                    v-show="shouldShowDay(day.date)"
                    @click="showDetails(day)" 
                    class="bg-white rounded-xl shadow-lg overflow-hidden transition duration-300 hover:shadow-xl cursor-pointer relative"
                    :class="{
                        'ring-4 ring-red-500/70 shadow-2xl bg-yellow-50': day.isToday
                    }"> 
                    
                    <div v-if="day.isToday" class="absolute top-0 left-0 px-3 py-1 bg-red-600 text-white text-xs font-bold rounded-br-xl z-10">
                        ğŸ“Œ ä»Šæ—¥è¡Œç¨‹
                    </div>

                    <div :class="`card-bg-${day.city_code}`"
                        class="h-16 w-full flex justify-between items-center p-3 text-white">
                        
                        <span class="text-xl font-extrabold tracking-wider mr-2">{{ day.city }}</span>
                        
                        <div class="weather-info">
                            <i :class="getWeatherIcon(day.weather)" class="fa-solid mr-1 text-yellow-300 text-lg"></i>
                            <div class="flex flex-col items-end leading-none">
                                <span class="font-bold text-sm">{{ day.weather }}</span>
                                <span class="text-xs opacity-90">{{ day.temp }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="p-3 border-l-4 border-orange-500"> 
                        <span class="text-lg font-extrabold text-slate-800 block mb-1">{{ day.date }}</span>
                        <p class="text-sm text-slate-700 truncate">{{ day.desc }}</p>
                        <p v-if="day.accommodation_note" class="text-xs text-slate-500 mt-2 flex items-center bg-slate-100 p-1 rounded-md w-fit">
                            <i class="fa-solid fa-bed mr-1 text-orange-500"></i> {{ day.accommodation_note }}
                        </p>
                    </div>
                </div>
            </section>

            <section v-if="currentTab === 'essentials'" class="space-y-6">
                <div v-if="essentialsMode === 'main'" class="space-y-6">
                    
                    <button @click="essentialsMode = 'apps'" class="w-full bg-slate-900 text-white p-4 rounded-xl shadow-lg flex items-center justify-between transition active:scale-95">
                        <span class="font-bold text-lg"><i class="fa-solid fa-mobile-screen-button text-orange-500 mr-2"></i> å¯¦ç”¨App ä¸‹è¼‰</span>
                        <i class="fa-solid fa-chevron-right"></i>
                    </button>

                    <div class="bg-green-50 p-4 rounded-xl shadow-md border-l-4 border-green-500">
                        <h3 class="font-bold text-green-800 text-lg mb-2 flex items-center"><i class="fa-solid fa-plane-departure mr-2"></i> èˆªç­è³‡è¨Š</h3>
                        <div class="space-y-2 text-sm">
                            <a href="https://booking.evaair.com/flyeva/eva/b2c/manage-your-trip/online-checked-in-login.aspx?lang=zh-tw" target="_blank" class="font-bold text-blue-700 hover:text-blue-500 hover:underline transition duration-150 block">
                                æŒ‰æ­¤æ–¼èµ·é£›å‰ 48 å°æ™‚å…§è¾¦ç†ç·šä¸Šå ±åˆ°
                            </a>
                            <hr class="border-green-300">
                            <p><span class="font-semibold text-slate-900">å»ç¨‹ (é•·æ¦®BR867):</span> 2026/01/01 (09:50 - 11:50)</p>
                            <p><span class="font-semibold text-slate-900">å›ç¨‹ (é•·æ¦®BR868):</span> 2026/01/04 (13:30 - 15:20)</p>
                        </div>
                    </div>

                    <div class="bg-blue-50 p-4 rounded-xl shadow-md border-l-4 border-blue-500">
                        <h3 class="font-bold text-blue-800 text-lg mb-3 flex items-center"><i class="fa-solid fa-house-user mr-2"></i> ä½å®¿åœ°å€</h3>

                        <div class="mb-4 pb-3 border-b border-blue-200">
                            <p class="font-bold text-base text-slate-900 mb-1">ğŸ‡¨ğŸ‡³ æ·±åœ³</p>
                            
                            <a href="https://tw.trip.com/hotels/shenzhen-hotel-detail-41520773/bangtuo-meinuo-executive-apartment/" target="_blank" class="font-bold text-orange-600 hover:text-orange-500 hover:underline transition duration-150 text-base block">
                                é‚¦æ‹“ç¾è«¾è¡Œæ”¿å…¬å¯“ï¼ˆæ·±åœ³å‰æµ·å»£å ´åº—ï¼‰
                            </a>
                            
                            <p class="text-xs text-slate-600 mt-1">
                                å—å±±å€, æœˆäº®ç£å¤§é“1104è™Ÿä½³å…†æ¥­å‰æµ·å»£å ´äºŒæœŸBåº§5æ¨“506å®¤
                            </p>
                        
                        </div>

                        <div>
                            <p class="font-bold text-base text-slate-900 mb-1">ğŸ‡­ğŸ‡° é¦™æ¸¯</p>
                            
                            <a href="https://tw.trip.com/hotels/hong-kong-hotel-detail-7114825/camlux-hotel/" target="_blank" class="font-bold text-orange-600 hover:text-orange-500 hover:underline transition duration-150 text-base block">
                                é¦™æ¸¯å›ç«‹é…’åº—
                            </a>
                            
                            <p class="text-xs text-slate-600 mt-1">
                                è§€å¡˜å€, ä¹é¾ç£å®å…‰é“15è™Ÿ
                            </p>
                            <a href="https://www.google.com/maps/place/%E5%90%9B%E7%AB%8B%E9%85%92%E5%BA%97/@22.3237639,114.2034422,17z/data=!3m1!4b1!4m9!3m8!1s0x34040132e4727759:0xaefe60d32380705b!5m2!4m1!1i2!8m2!3d22.3237639!4d114.2060171!16s%2Fg%2F11c5s98sdf?entry=ttu&g_ep=EgoyMDI1MTIwMi4wIKXMDSoASAFQAw%3D%3D" target="_blank" class="text-xs text-blue-600 font-semibold hover:underline mt-1 inline-block">åœ¨ Google åœ°åœ–ä¸ŠæŸ¥çœ‹ <i class="fa-solid fa-location-dot ml-1"></i></a>
                        </div>
                    </div>

                    <div class="bg-red-50 p-4 rounded-xl shadow-md border-l-4 border-red-500">
                        <h3 class="font-bold text-red-800 text-lg mb-2 flex items-center"><i class="fa-solid fa-phone-volume mr-2"></i> ç·Šæ€¥æ±‚åŠ©é›»è©±ï¼ˆé»æ“Šæ’¥å‡ºï¼‰</h3>
                        <div class="flex justify-around text-sm font-medium">
                            <a href="tel:999" class="text-center text-slate-700 hover:text-red-600 p-1 rounded-md transition duration-150">
                                ğŸ‡­ğŸ‡° **é¦™æ¸¯ï¼š** <span class="font-black text-xl">999</span>
                            </a>
                            <a href="tel:110" class="text-center text-slate-700 hover:text-red-600 p-1 rounded-md transition duration-150">
                                ğŸ‡¨ğŸ‡³ **ä¸­åœ‹å¤§é™¸ ï¼š** <span class="font-black text-xl">110</span>
                            </a>
                        </div>
                    </div>

                    <div class="bg-yellow-50 p-4 rounded-xl shadow-md border-l-4 border-yellow-500">
                        <h3 class="font-bold text-yellow-800 text-lg mb-2 flex items-center"><i class="fa-solid fa-exclamation-circle mr-2"></i> æ—…éŠæ³¨æ„äº‹é …</h3>
                        <ul class="list-disc list-inside text-sm space-y-1 text-slate-700">
                            <li>**é›»æºï¼š** 220Véƒ¨åˆ†é›»å™¨éœ€ä½¿ç”¨è½‰æ¥é ­åŠè®Šå£“å™¨ã€‚</li>
                            <li>**å…¥å¢ƒï¼š** ä¸å¯æ”œå¸¶åŠ ç†±ç…™åŠå¤šæ–¼19æ”¯é¦™ç…™å…¥å¢ƒ ã€‚</li>
                            <li>**è­‰ä»¶ï¼š** è‹¥æœªéš¨èº«æ”œå¸¶èº«ä»½è­‰æ˜æ–‡ä»¶å±¬æ–¼é•æ³•</li>
                        </ul>
                    </div>
                </div>

                <div v-if="essentialsMode === 'apps'" class="space-y-4">
                    <button @click="essentialsMode = 'main'" class="text-slate-500 font-bold mb-2 flex items-center hover:text-slate-800">
                        <i class="fa-solid fa-chevron-left mr-2"></i> è¿”å›é‡è¦è³‡è¨Š
                    </button>

                    <div class="bg-blue-600 text-white p-4 rounded-2xl shadow-lg mb-4">
                        <h3 class="font-bold text-lg mb-1"><i class="fa-solid fa-download mr-2"></i>è¡Œå‰App</h3>
                        <p class="text-xs opacity-80">å»ºè­°åœ¨å‡ºç™¼å‰å®Œæˆä¸‹è¼‰</p>
                    </div>

                    <div v-for="(apps, region) in appList" :key="region">
                        <h4 class="font-bold text-slate-800 border-b-2 border-orange-400 pb-1 mb-3 mt-4 flex items-center">
                            {{ region }}
                        </h4>
                        <div class="space-y-3">
                            <div v-for="app in apps" :key="app.name" class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="flex items-center">
                                        <div class="mr-3 text-xl text-slate-700 w-8 text-center"><i :class="app.icon"></i></div>
                                        <div>
                                            <p class="font-bold text-slate-800">{{ app.name }}</p>
                                            <p class="text-xs text-slate-500">{{ app.desc }}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <a :href="app.ios" target="_blank" class="flex-1 bg-black text-white text-[10px] py-2 px-1 rounded-lg text-center flex items-center justify-center transition hover:bg-gray-800">
                                        <i class="fa-brands fa-apple mr-1 text-sm"></i> App Store
                                    </a>
                                    <a :href="app.android" target="_blank" class="flex-1 bg-green-600 text-white text-[10px] py-2 px-1 rounded-lg text-center flex items-center justify-center transition hover:bg-green-700">
                                        <i class="fa-brands fa-android mr-1 text-sm"></i> Android
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </section>

            <section v-if="currentTab === 'finance'">
                
                
                <div @click="openStatsModal" class="bg-slate-900 text-white p-4 rounded-2xl mb-4 shadow-lg cursor-pointer transition duration-150 hover:bg-slate-800">
                    <p class="text-xs opacity-70 flex justify-between items-center">
                        ç¸½æ”¯å‡º (TWD)
                        <i class="fa-solid fa-chart-pie text-base"></i>
                    </p>
                    <p class="text-2xl font-bold">TWD ${{ totalExpenseTWD.toFixed(0) }}</p>
                </div>

                <div class="space-y-2 mb-6 p-4 border border-dashed rounded-xl bg-orange-50">
                    <h4 class="font-bold text-slate-800 mb-2">æ–°å¢æ”¯å‡ºé …ç›®</h4>
                    
                    <div class="w-full">
                        <div v-if="newExpense.category === 'äº¤é€š' && newExpense.item !== 'å…¶ä»–äº¤é€š'">
                            <select v-model="newExpense.item" class="w-full p-3 border rounded-xl text-sm bg-white focus:ring-orange-500 focus:border-orange-500">
                                <option value="">è«‹é¸æ“‡äº¤é€šæ–¹å¼ (éå¿…å¡«)</option>
                                <option value="å·´å£«">å·´å£«</option>
                                <option value="åœ°éµ">åœ°éµ</option>
                                <option value="çš„å£«">çš„å£«</option>
                                <option value="è·¨å¢ƒäº¤é€š">è·¨å¢ƒäº¤é€š</option>
                                <option value="å…¶ä»–äº¤é€š">å…¶ä»–</option>
                            </select>
                        </div>
                        <div v-else-if="newExpense.category === 'äº¤é€š' && newExpense.item === 'å…¶ä»–äº¤é€š'">
                               <input v-model="newExpense.item" placeholder="è«‹è¼¸å…¥äº¤é€šç°¡è¿° (éå¿…å¡«)" class="w-full p-3 border rounded-xl text-sm focus:ring-orange-500 focus:border-orange-500">
                        </div>
                        <div v-else>
                            <input v-model="newExpense.item" placeholder="ç°¡è¿° (éå¿…å¡«)" class="w-full p-3 border rounded-xl text-sm focus:ring-orange-500 focus:border-orange-500">
                        </div>
                    </div>
                    
                    <div class="flex gap-2">
                            <select v-model="newExpense.category" class="w-1/3 p-3 border rounded-xl text-sm bg-white focus:ring-orange-500 focus:border-orange-500">
                                <option value="åƒå–">åƒå–</option>
                                <option value="äº¤é€š">äº¤é€š</option>
                                <option value="è³¼ç‰©">è³¼ç‰©</option>
                                <option value="é–€ç¥¨">é–€ç¥¨</option>
                                <option value="å…¶ä»–">å…¶ä»–</option>
                            </select>
                            <input v-model.number="newExpense.amount" type="number" placeholder="é‡‘é¡" class="w-1/3 p-3 border rounded-xl text-sm focus:ring-orange-500 focus:border-orange-500 text-right">
                            <select v-model="newExpense.currency" class="w-1/4 p-3 border rounded-xl text-sm bg-white focus:ring-orange-500 focus:border-orange-500">
                                <option value="HKD">HKD</option>
                                <option value="RMB">RMB</option>
                                <option value="TWD">TWD</option>
                            </select>
                    </div>

                    <select v-model="newExpense.method" class="w-full p-3 border rounded-xl text-sm bg-white focus:ring-orange-500 focus:border-orange-500">
                        <option value="ç¾é‡‘">ç¾é‡‘</option>
                        <option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option>
                        <option value="å…«é”é€š">å…«é”é€š</option>
                        <option value="é›»å­æ”¯ä»˜">é›»å­æ”¯ä»˜</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                    <button @click="addExpense" :disabled="!newExpense.amount" class="w-full bg-orange-500 disabled:opacity-50 text-white p-3 rounded-xl font-bold shadow-lg active:scale-95 transition">æ–°å¢æ”¯å‡º</button>
                </div>

                <div v-for="(exp, index) in expenses" :key="exp.id" class="p-3 border-b border-slate-200 hover:bg-slate-50 transition duration-100">
                    <div v-if="!exp.isEditing" class="flex justify-between items-start text-sm">
                        <div class="flex-1">
                            <span class="font-bold text-slate-800">{{ exp.item }}</span>
                            <small class="text-slate-400 block">{{ getCategoryLabel(exp.category) }} ({{ exp.method }})</small>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-red-500 text-base block">- {{ exp.currency }} {{ exp.amount }}</span>
                            <span v-if="exp.currency !== 'TWD'" class="text-xs text-slate-500">
                                (ç´„ TWD {{ convertToTWD(exp.amount, exp.currency).toFixed(0) }})
                            </span>
                            <div class="flex justify-end gap-3 pt-1 mt-1">
                                <button @click="toggleEdit(exp)" class="text-xs text-blue-500 hover:text-blue-700 font-medium"><i class="fa-solid fa-edit mr-1"></i>ç·¨è¼¯</button>
                                <button @click="deleteExpense(exp.id)" class="text-xs text-red-500 hover:text-red-700 font-medium"><i class="fa-solid fa-trash-alt mr-1"></i>åˆªé™¤</button>
                            </div>
                        </div>
                    </div>

                    <div v-else class="p-2 bg-white rounded-lg border border-blue-300">
                            <h4 class="font-bold text-sm mb-2 text-blue-600">ç·¨è¼¯æ”¯å‡º</h4>
                            
                            <div v-if="exp.category === 'äº¤é€š' && exp.item === 'å…¶ä»–äº¤é€š'">
                                 <input v-model="exp.item" placeholder="è«‹è¼¸å…¥äº¤é€šç°¡è¿°" class="w-full p-2 border rounded-lg text-sm mb-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div v-else-if="exp.category === 'äº¤é€š'">
                                 <select v-model="exp.item" class="w-full p-2 border rounded-lg text-sm mb-2 bg-white focus:ring-blue-500 focus:border-blue-500">
                                     <option value="å·´å£«">å·´å£«</option>
                                     <option value="åœ°éµ">åœ°éµ</option>
                                     <option value="çš„å£«">çš„å£«</option>
                                     <option value="è·¨å¢ƒäº¤é€š">è·¨å¢ƒäº¤é€š</option>
                                     <option value="å…¶ä»–äº¤é€š">å…¶ä»–</option>
                                 </select>
                            </div>
                            <div v-else>
                                 <input v-model="exp.item" placeholder="ç°¡è¿°" class="w-full p-2 border rounded-lg text-sm mb-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>

                            <div class="flex gap-2 mb-2">
                                 <select v-model="exp.category" class="w-1/3 p-2 border rounded-lg text-sm bg-white">
                                     <option value="åƒå–">åƒå–</option>
                                     <option value="äº¤é€š">äº¤é€š</option>
                                     <option value="è³¼ç‰©">è³¼ç‰©</option>
                                     <option value="é–€ç¥¨">é–€ç¥¨</option>
                                     <option value="å…¶ä»–">å…¶ä»–</option>
                                 </select>
                                 <input v-model.number="exp.amount" type="number" placeholder="é‡‘é¡" class="w-1/3 p-2 border rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500 text-right">
                                  <select v-model="exp.currency" class="w-1/4 p-2 border rounded-lg text-sm bg-white">
                                      <option value="HKD">HKD</option>
                                      <option value="RMB">RMB</option>
                                      <option value="TWD">TWD</option>
                                  </select>
                            </div>
                            <select v-model="exp.method" class="w-full p-2 border rounded-lg text-sm mb-3 bg-white">
                                 <option value="ç¾é‡‘">ç¾é‡‘</option>
                                 <option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option>
                                 <option value="å…«é”é€š">å…«é”é€š</option>
                                 <option value="é›»å­æ”¯ä»˜">é›»å­æ”¯ä»˜</option>
                                 <option value="å…¶ä»–">å…¶ä»–</option>
                            </select>

                            <button @click="toggleEdit(exp)" class="w-full bg-blue-600 text-white p-2 rounded-xl font-bold active:scale-95 transition">
                                     å„²å­˜ä¿®æ”¹ <i class="fa-solid fa-save ml-1"></i>
                            </button>
                    </div>
                </div>
            </section>

            <section v-if="currentTab === 'wishlist'" class="space-y-4">
                <div class="mb-4">
                    <select v-model="selectedMember" class="w-full p-3 border border-orange-300 rounded-xl text-sm font-bold bg-white shadow-md focus:ring-2 focus:ring-orange-500">
                        <option value="å…¨éƒ¨">æ‰€æœ‰äºº (é¡¯ç¤ºæ‰€æœ‰é¡˜æœ›)</option>
                        <option v-for="member in members" :key="member" :value="member">{{ member }}</option>
                    </select>
                </div>

                <div class="flex gap-2 mb-6">
                    <select v-model="newWishItem.member" class="p-3 border rounded-xl text-sm bg-white font-medium">
                        <option v-for="member in members" :key="member + '_add'" :value="member">{{ member }}</option>
                    </select>
                    <input v-model="newWishItem.item" @keyup.enter="addWishItem" placeholder="æƒ³è²·ä»€éº¼..." class="flex-1 p-3 border rounded-lg text-sm focus:ring-orange-500 focus:border-orange-500">
                    <button @click="addWishItem" class="bg-slate-900 text-white px-4 rounded-xl active:scale-95 transition"><i class="fa-solid fa-plus"></i></button>
                </div>

                <div v-if="filteredWishlist.length > 0" class="space-y-2">
                    <div v-for="(item, index) in filteredWishlist" :key="item.id" class="flex items-center p-3 bg-slate-50 rounded-xl justify-between">
                        <div class="flex items-center">
                            <input type="checkbox" v-model="item.done" @change="syncToCloud" class="mr-3 w-5 h-5 accent-orange-500">
                            <span :class="{'line-through text-slate-400': item.done}" class="text-sm font-medium">{{ item.item }}</span>
                        </div>
                        <span v-if="selectedMember === 'å…¨éƒ¨'" class="text-xs bg-orange-100 text-orange-600 px-2 py-1 rounded-full">{{ item.member }}</span>
                        
                        <button @click="deleteWishItem(item.id)" class="ml-3 text-red-500 hover:text-red-700">
                            <i class="fa-solid fa-times text-xs"></i>
                        </button>
                    </div>
                </div>
                <div v-else class="text-center text-slate-500 p-8 border border-dashed rounded-xl">
                    <i class="fa-solid fa-face-frown text-2xl mb-2"></i>
                    <p>{{ selectedMember }} çš„é¡˜æœ›æ¸…å–®æ˜¯ç©ºçš„ï¼</p>
                </div>
            </section>

            <div class="mt-12 mb-8 text-center border-t border-slate-200 pt-6">
                <p class="text-[10px] text-slate-400 uppercase tracking-widest mb-3">Service Provided By</p>
                
                <a href="https://www.instagram.com/j3cab.kaohsiung?igsh=ZnJ6OTY5bzFhNXBs" target="_blank" class="group inline-flex flex-col items-center transition duration-300 hover:scale-105">
                    <img src="./15473.png" alt="J3Cab Logo" class="h-16 w-auto object-contain rounded-xl shadow-md group-hover:shadow-xl group-hover:ring-2 group-hover:ring-orange-400 transition duration-300">
                    
                    <div class="mt-2 flex items-center gap-1 text-slate-800 font-bold tracking-wider group-hover:text-orange-600 transition">
                        <i class="fa-brands fa-instagram text-lg"></i>
                        <span>J3Cab</span>  
                    </div>
                     <p class="text-[20px] text-slate-800 font-medium tracking-wide mt-0.5 group-hover:text-orange-500 transition">
    é»æ“Šè¿½è¹¤ç²å–æ›´å¤šåŒ…è»ŠåŠæ—…éŠè³‡è¨Š
</p>
                </a>
            </div>

        </main> 

        </main>
        
        <div v-if="isStatsModalOpen" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex justify-center items-center z-50">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-sm">
                <div class="flex justify-between items-center border-b pb-3 mb-4">
                    <h3 class="text-xl font-bold text-slate-800">æ”¯å‡ºåˆ†æ (TWD)</h3>
                    <button @click="isStatsModalOpen = false" class="text-gray-500 hover:text-gray-800">
                        <i class="fa-solid fa-times text-lg"></i>
                    </button>
                </div>

                <div class="space-y-4">
                    <div class="w-full h-64 flex justify-center">
                        <canvas id="expenseChart"></canvas>
                    </div>

                    <h4 class="font-bold text-sm text-orange-600 mt-4">ç¸½æ”¯å‡º TWD ${{ totalExpenseTWD.toFixed(0) }}</h4>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div v-for="(amount, category) in categoryTotals" :key="category" class="flex justify-between border-b pb-1">
                            <span>{{ category }}</span>
                            <span class="font-medium text-slate-700">TWD {{ amount.toFixed(0) }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="isDetailModalOpen && selectedDayDetails" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex justify-center items-center z-50 p-4">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center border-b pb-3 mb-4">
                    <h3 class="text-xl font-bold text-slate-800">
                        {{ isEditMode ? 'ç·¨è¼¯è¡Œç¨‹' : selectedDayDetails.date + ' è©³æƒ…' }}
                    </h3>
                    <button @click="closeModal" class="text-gray-500 hover:text-gray-800">
                        <i class="fa-solid fa-times text-lg"></i>
                    </button>
                </div>

                <div v-if="!isEditMode" class="space-y-4">
                    <p class="text-sm text-slate-600 mb-4">{{ selectedDayDetails.summary }}</p>
                    
                    <h4 class="font-bold text-orange-600 text-lg border-b pb-1 mb-3">ç•¶æ—¥è¡Œç¨‹é»</h4>
                    
                    <div v-for="(item, index) in selectedDayDetails.details" :key="index" class="p-3 border-l-4 border-orange-500 bg-slate-50 transition duration-150">
                        <p class="font-bold text-slate-800 mb-1 flex items-start text-sm">
                            <i class="fa-solid fa-location-dot mr-2 mt-1 text-orange-500 flex-shrink-0"></i> 
                            <span class="flex-grow">
                                <span v-if="item.time" class="text-orange-600 mr-2 font-mono">{{ item.time }}</span>
                                <span>{{ item.name }}</span>
                            </span>
                        </p>
                        <p v-if="item.note" class="text-xs text-slate-500 ml-5">{{ item.note }}</p>
                    </div>

                    <div class="flex gap-2 mt-4">
                        <button @click="startEdit" class="w-full bg-blue-600 text-white p-2 rounded-xl font-bold hover:bg-blue-700 transition">
                             <i class="fa-solid fa-edit mr-1"></i> ç·¨è¼¯è¡Œç¨‹
                        </button>
                        <button @click="closeModal" class="w-full bg-slate-200 text-slate-800 p-2 rounded-xl font-bold hover:bg-slate-300 transition">
                             é—œé–‰
                        </button>
                    </div>
                </div>

                <div v-else class="space-y-4">
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase">ç°¡è¿°</label>
                        <input v-model="editBuffer.desc" class="w-full p-2 border rounded mt-1 text-sm">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase">è©³ç´°æè¿°</label>
                        <textarea v-model="editBuffer.summary" rows="2" class="w-full p-2 border rounded mt-1 text-sm"></textarea>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase">ä½å®¿å‚™è¨»</label>
                        <input v-model="editBuffer.accommodation_note" class="w-full p-2 border rounded mt-1 text-sm">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase">è©³ç´°è¡Œç¨‹</label>
                        <textarea v-model="detailsString" rows="8" class="w-full p-2 border rounded mt-1 text-sm font-mono" placeholder="10:00|å‡ºç™¼|å‚™è¨»(é¸å¡«)"></textarea>
                        <p class="text-[10px] text-slate-400 mt-1">æ ¼å¼ç¯„ä¾‹: <span class="font-bold">14:20|å¥³å‹æŠµæ¸¯|å…©äººç´„åœ¨æ©Ÿå ´æœƒåˆ</span><br>(æ¯ä¸€è¡Œä»£è¡¨ä¸€å€‹è¡Œç¨‹é»ï¼Œç”¨ | åˆ†éš”)</p>
                    </div>
                    <div class="flex gap-2">
                        <button @click="saveEdit" class="flex-1 bg-green-600 text-white p-2 rounded-xl font-bold hover:bg-green-700">å„²å­˜é›²ç«¯</button>
                        <button @click="isEditMode = false" class="flex-1 bg-slate-200 text-slate-800 p-2 rounded-xl font-bold hover:bg-slate-300">å–æ¶ˆ</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

<script>
    const { createApp, ref, computed, watch, onMounted, nextTick } = Vue;

    // ğŸ”¥ 1. Firebase è¨­å®š
    const firebaseConfig = {
        apiKey: "AIzaSyDUJOYe8nisgggOU9iSbzoWHgid7Rf9rY0",
        authDomain: "webapp-69d9d.firebaseapp.com",
        projectId: "webapp-69d9d",
        storageBucket: "webapp-69d9d.firebasestorage.app",
        messagingSenderId: "920749669744",
        appId: "1:920749669744:web:1928274d2fca3a0e8e23b5",
        measurementId: "G-4X3ML4V0BN"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function getComparableDate(dateString) {
        const [month, day] = dateString.split('/').map(Number);
        let year = month === 1 ? 2026 : 2025;
        return new Date(year, month - 1, day);
    }
    
    // 2. åŸå§‹æ•¸æ“š (å·²æ›´æ–° 12/25 çš„ç°è‰²å‚™è¨»)
    const FIXED_SCHEDULE = [
        { 
            id: 1, date: '12/25', city: 'é¦™æ¸¯', city_code: 'HK', desc: 'è–èª•ç¯€ï¼šæŠµæ¸¯ã€æµ·æ¸¯åŸç‡ˆé£¾', weather: 'å¤šé›²', temp: '21Â°C / 15Â°C', 
            summary: 'è–èª•ç¯€å…©äººå„è‡ªæŠµæ¸¯å¾Œæœƒåˆï¼Œå‰å¾€ä¹é¾å€æ„Ÿå—æ¿ƒåšçš„è–èª•æ°£æ°›å’Œç¶­æ¸¯å¤œæ™¯ã€‚', 
            accommodation_note: 'æ™šä¸Šä½ï¼šé¦™æ¸¯ç²‰å¶ºçš„å®¶', 
                        details: [
                { time: '14:20', name: 'å¥³å‹èˆªç­ BR869 (TPE) æŠµæ¸¯', note: 'å…©äººç´„åœ¨æ©Ÿå ´æœƒåˆ' },
                { time: '15:00', name: 'æ‚¨çš„èˆªç­ CX423 (KHH) æŠµæ¸¯', note: 'æœƒåˆå¾Œï¼Œå…ˆå›é¦™æ¸¯å®¶å®‰é “' }, 
                { time: '18:00', name: 'å°–æ²™å’€ (Tsim Sha Tsui) æµ·æ¸¯åŸ/å»£æ±é“', note: 'è§€è³è–èª•å¤§å‹ç‡ˆé£¾ä½ˆç½®èˆ‡ç¶­æ¸¯å¤œæ™¯' }, 
                { time: '20:00', name: 'è–èª•æ™šé¤èˆ‡è³¼ç‰©', note: 'åœ¨æµ·æ—æˆ–å•†å ´äº«ç”¨æ™šé¤' }
            ] 
        },
        { id: 2, date: '12/26', city: 'é¦™æ¸¯', city_code: 'HK', desc: 'é¦™æ¸¯è¡Œç¨‹ï¼šPartyroom äº¤æ›ç¦®ç‰©', weather: 'æ™´æœ—', temp: '20Â°C / 15Â°C', summary: 'ä»Šæ—¥åœ¨é¦™æ¸¯æ´»å‹•ï¼Œæ™šä¸Šçš„é‡é ­æˆ²æ˜¯ Partyroom äº¤æ›ç¦®ç‰©ã€‚', accommodation_note: 'æ™šä¸Šä½ï¼šé¦™æ¸¯ç²‰å¶ºçš„å®¶', details: [{ name: 'ç™½å¤©ï¼šé¦™æ¸¯è‡ªç”±æ´»å‹•' }, { name: 'æ™šä¸Šï¼šPartyroom äº¤æ›ç¦®ç‰©' }] },
        { id: 3, date: '12/27', city: 'é¦™æ¸¯', city_code: 'HK', desc: 'é›¢å³¶/æ–‡åŒ–ï¼šå—ä¸«å³¶æˆ–è¥¿ä¹æ–‡åŒ–å€', weather: 'å¤šé›²', temp: '16Â°C / 11Â°C', summary: 'æ‚ é–’è¡Œç¨‹ã€‚', accommodation_note: 'æ™šä¸Šä½ï¼šé¦™æ¸¯ç²‰å¶ºçš„å®¶', details: [{ time: '10:00', name: 'å—ä¸«å³¶ä¸€æ—¥éŠ' }] },
        { id: 4, date: '12/28', city: 'å»£å·', city_code: 'GZ', desc: 'å»£å·ç¬¬ä¸€æ—¥ï¼šå»£å·å¡”ã€ç æ±Ÿå¤œéŠ', weather: 'å¤§é›¨', temp: '15Â°C / 10Â°C', summary: 'æ­é«˜éµå‰å¾€å»£å·ã€‚', accommodation_note: 'æ™šä¸Šä½ï¼šå»£å·å¸Œå²¸é…’åº—', details: [{ time: '09:00', name: 'é«˜éµè‡³å»£å·' }, { time: '19:00', name: 'å»£å·å¡”/ç æ±Ÿå¤œéŠ' }] },
        { id: 5, date: '12/29', city: 'å»£å·', city_code: 'GZ', desc: 'å»£å·ç¬¬äºŒæ—¥ï¼šæ²™é¢å³¶ã€åœ°é“ç²µå¼é»å¿ƒ', weather: 'æ™´æ™‚å¤šé›²', temp: '16Â°C / 11Â°C', summary: 'æ¼«æ­¥è€åŸï¼Œå‚æ™šå›æ¸¯ã€‚', accommodation_note: 'æ™šä¸Šä½ï¼šå»£å·å¸Œå²¸é…’åº—', details: [{ time: '10:00', name: 'æ²™é¢å³¶æ•£æ­¥' }, { time: '17:00', name: 'æ­é«˜éµå›æ¸¯' }] },
        { id: 6, date: '12/30', city: 'æ·±åœ³', city_code: 'SZ', desc: 'æ·±åœ³äºŒæ—¥éŠ', weather: 'å¤šé›²', temp: '19Â°C / 14Â°C', summary: 'å‰å¾€æ·±åœ³æ·±åº¦æ¢ç´¢ã€‚', accommodation_note: 'æ™šä¸Šä½ï¼šæœªå®š', details: [{ time: '10:00', name: 'å‰å¾€æ·±åœ³' }] },
        { id: 7, date: '12/31', city: 'æ·±åœ³/é¦™æ¸¯', city_code: 'SZ', desc: 'æ·±åœ³éŠç©ã€æ™šä¸Šå›æ¸¯è·¨å¹´', weather: 'æ™´æœ—', temp: '17Â°C / 12Â°C', summary: 'æ—¥é–“åœ¨æ·±åœ³ï¼Œæ™šä¸Šè¿”å›ç¶­æ¸¯è·¨å¹´ã€‚', accommodation_note: 'æ™šä¸Šä½ï¼šé¦™æ¸¯çš„å®¶', details: [{ name: 'æ—¥é–“ï¼šæ·±åœ³éŠç©' }, { time: '23:30', name: 'ç¶­æ¸¯è·¨å¹´å€’æ•¸' }] },
        { id: 8, date: '01/01', city: 'æ·±åœ³', city_code: 'SZ', desc: 'æ¥æ©Ÿã€è”ç£åƒé£¯ã€è¯å¼·åŒ—ã€ç«é‹æŒ‰æ‘©', weather: 'å°é›¨', temp: '18Â°C / 13Â°C', summary: 'æ¥æ©Ÿå¾Œç›´å¥”æ·±åœ³å±•é–‹è³¼ç‰©ç¾é£Ÿè¡Œã€‚', accommodation_note: 'æ™šä¸Šä½ï¼šæ·±åœ³é‚¦æ‹“ç¾è«¾è¡Œæ”¿å…¬å¯“ï¼ˆæ·±åœ³å‰æµ·å»£å ´åº—ï¼‰', details: [{ time: '12:00', name: 'æŠµé”é¦™æ¸¯' }, { time: '12:30', name: 'é›¢é–‹æ©Ÿå ´' }, { time: '13:30', name: 'æŠµé”æ·±åœ³' }, { time: '14:00', name: 'è”ç£åƒé£¯' }, { name: 'è¯å¼·åŒ—' }, { name: 'æ±é–€' }, { name: 'æ½®ç™¼æ±•é ­ç‰›è‚‰ç«é‹' }, { name: 'æŒ‰æ‘©' }] },
        { id: 9, date: '01/02', city: 'é¦™æ¸¯', city_code: 'HK', desc: 'å›æ¸¯æ²¹å°–æ—ºã€åŸå·´H2ã€æ˜Ÿå…‰å¤§é“', weather: 'æ™´æ™‚å¤šé›²', temp: '17Â°C / 12Â°C', summary: 'ä¸­åˆå›æ¸¯æ”¾è¡Œæï¼Œä¸‹åˆæ·±åº¦éŠä¹é¾ã€‚', accommodation_note: 'æ™šä¸Šä½ï¼šé¦™æ¸¯å›ç«‹é…’åº—', details: [{ time: '08:30', name: 'å‡ºç™¼' }, { name: 'æ·±åœ³åƒæ—©é¤' }, { time: '10:30', name: 'é›¢é–‹æ·±åœ³' }, { time: '12:00', name: 'åˆ°ä¹é¾ç£æ”¾è¡Œæ' }, { time: '12:30', name: 'æ—ºè§’èŒ¶é¤å»³åƒé£¯' }, { time: '13:30', name: 'æ—ºè§’æ²¹éº»åœ°å°–æ²™å˜´' }, { time: '17:00', name: 'åŸå·´H2' }, { name: 'å¤©æ˜Ÿå°è¼ª' }, { name: 'æ˜Ÿå…‰å¤§é“' }, { name: 'å»Ÿè¡—å¤œå¸‚ç…²ä»”é£¯' }, { name: 'å›é£¯åº—' }] },
        { id: 10, date: '01/03', city: 'é¦™æ¸¯', city_code: 'HK', desc: 'ä¸­ç’°æ‡·èˆŠã€éŠ…é‘¼ç£é€›è¡—ã€å¤ªå¹³å±±', weather: 'å¤šé›²', temp: '16Â°C / 11Â°C', summary: 'èµ°è¨ªæ¸¯å³¶ç¶“å…¸æ™¯é»ã€‚', accommodation_note: 'æ™šä¸Šä½ï¼šé¦™æ¸¯å›ç«‹é…’åº—', details: [{ time: '08:00', name: 'å‡ºç™¼' }, { name: 'ä¹é¾ç£èŒ¶é¤å»³æ—©é¤' }, { name: 'çš‡ååƒå»£å ´' }, { name: 'ä¸­ç’°è¡—å¸‚' }, { name: 'åŠå±±æ‰‹æ‰¶æ¢¯' }, { name: 'å¤§é¤¨' }, { name: 'çŸ³æ¿è¡—' }, { time: '12:00', name: 'ä¸­ç’°è“®é¦™æ¨“' }, { name: 'è˜­èŠ³åœ’' }, { name: 'éŠ…é‘¼ç£é€›è¡—' }, { name: 'ç‡’è‡˜é£¯' }, { name: 'ç³–æ°´' }, { name: 'ä¸­ç’°' }] },
        { id: 11, date: '01/04', city: 'é¦™æ¸¯ (é›¢å¢ƒ)', city_code: 'HK', desc: 'æœ€å¾Œæ—©èŒ¶ã€å‰å¾€æ©Ÿå ´', weather: 'æ™´æœ—', temp: '19Â°C / 14Â°C', summary: 'äº«ç”¨æ—©èŒ¶å¾Œå‰å¾€æ©Ÿå ´ã€‚', accommodation_note: 'æ™šä¸Šä½ï¼šæº«æš–çš„å®¶', details: [{ name: 'è§€å¡˜æ—©èŒ¶ or å†°å®¤' }, { time: '10:30', name: 'å‡ºç™¼' }, { time: '11:30', name: 'åˆ°æ©Ÿå ´' }] }
    ];

    const APP_LIST = {
        "ğŸ‡¨ğŸ‡³ ä¸­åœ‹å¤§é™¸ (æ·±åœ³)": [
            { name: "é«˜å¾·åœ°åœ–", desc: "å¤§é™¸å°èˆªå¿…å‚™", ios: "https://apps.apple.com/app/id461703208", android: "https://play.google.com/store/apps/details?id=com.autonavi.minimap", icon: "fa-solid fa-map-location-dot" },
        ],
        "ğŸ‡­ğŸ‡° é¦™æ¸¯": [
            { name: "OpenRice é–‹é£¯å–‡", desc: "ç¾é£Ÿæœå°‹è¨‚ä½", ios: "https://apps.apple.com/app/id310663323", android: "https://play.google.com/store/apps/details?id=com.openrice.android", icon: "fa-solid fa-utensils" },
            { name: "Pokeguide", desc: "åœ°éµå‡ºå£æ”»ç•¥", ios: "https://apps.apple.com/hk/app/pokeguide/id1007055917", android: "https://play.google.com/store/apps/details?id=com.pokeguide.pokeguide", icon: "fa-solid fa-map-location-dot" },
            { name: "Octopus å…«é”é€š", desc: "äº¤é€šã€å°é¡æ”¯ä»˜", ios: "https://apps.apple.com/app/id1114430602", android: "https://play.google.com/store/apps/details?id=com.octopuscards.nfc_reader", icon: "fa-solid fa-credit-card" },
            { name: "Citybus åŸå·´", desc: "åŸå·´è·¯ç·šæŸ¥è©¢", ios: "https://apps.apple.com/tw/app/%E5%9F%8E%E5%B7%B4-citybus/id472242340", android: "https://play.google.com/store/apps/details?id=com.nwfb", icon: "fa-solid fa-bus-simple" },
            { name: "App 1933 (KMB)", desc: "ä¹å·´/é¾é‹é å ±", ios: "https://apps.apple.com/hk/app/app1933-kmb-lwb/id1170003707", android: "https://play.google.com/store/apps/details?id=com.kmb.app1933", icon: "fa-solid fa-bus" },
             { name: "MTR Mobile", desc: "æ¸¯éµè·¯ç·šè¦åŠƒ", ios: "https://apps.apple.com/app/id369295276", android: "https://play.google.com/store/apps/details?id=com.mtr.mtrmobile", icon: "fa-solid fa-train-subway" },
        ]
    };

    createApp({
        setup() {
            const currentTab = ref('itinerary');
            const essentialsMode = ref('main');
            const isStatsModalOpen = ref(false);
            const isDetailModalOpen = ref(false);
            const isEditMode = ref(false);
            const selectedDayDetails = ref(null);
            const dbStatus = ref('è®€å–ä¸­...');
            const onlineCount = ref(1); // ç·šä¸Šäººæ•¸è®Šæ•¸
            
            const showEarlyTrip = ref(false);

            const editBuffer = ref({});
            const detailsString = ref("");

            const currentTime = ref("");
            const currentFullDate = ref("");
            const currentDateTime = ref(new Date());

            const realTimeWeather = ref(null);
            const localWeather = ref(null); // ç›®å‰ä½ç½®å¤©æ°£è®Šæ•¸

            const CITY_COORDS = {
                'HK': { lat: 22.3193, lon: 114.1694 },
                'SZ': { lat: 22.5431, lon: 114.0579 },
                'GZ': { lat: 23.1291, lon: 113.2644 }
            };

            const updateTime = () => {
                const now = new Date();
                currentDateTime.value = now;
                currentTime.value = now.toLocaleTimeString('zh-Hant', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                currentFullDate.value = now.toLocaleDateString('zh-Hant', { year: 'numeric', month: 'long', day: 'numeric' });
            };
            
            updateTime();
            setInterval(updateTime, 1000);

            const schedule = ref([]);
            const expenses = ref([]);
            const wishlist = ref([]);
            const appList = APP_LIST; 
            const newExpense = ref({ item: '', amount: null, currency: 'HKD', method: 'ç¾é‡‘', category: 'åƒå–' });
            const members = ['çˆ¸çˆ¸', 'åª½åª½', 'æ©å®œ', 'æŸå‘ˆ', 'å”æ²›'];
            const selectedMember = ref('å…¨éƒ¨');
            const newWishItem = ref({ member: 'æ©å®œ', item: '' });
            const calculator = ref({ amount: null, currency: 'HKD' });

            function getWeatherDesc(code) {
                const codes = {
                    0: 'â˜€ï¸ æ™´æœ—', 1: 'ğŸŒ¤ å¤šé›²', 2: 'â˜ï¸ é™°å¤©', 3: 'â˜ï¸ é™°æ²‰',
                    45: 'ğŸŒ« éœ§', 48: 'ğŸŒ« éœ§æ·', 
                    51: 'ğŸŒ§ æ¯›æ¯›é›¨', 53: 'ğŸŒ§ ä¸­åº¦æ¯›é›¨', 55: 'ğŸŒ§ å¼·æ¯›é›¨',
                    61: 'â˜” å°é›¨', 63: 'â˜” ä¸­é›¨', 65: 'â˜” å¤§é›¨',
                    80: 'â›ˆ é™£é›¨', 81: 'â›ˆ ä¸­é™£é›¨', 82: 'â›ˆ å¼·é™£é›¨'
                };
                return codes[code] || 'æœªçŸ¥';
            }

            async function fetchRealTimeWeather() {
                const todayDay = orderedSchedule.value.find(day => day.isToday);
                if (!todayDay) return;

                const coords = CITY_COORDS[todayDay.city_code];
                if (!coords) return;

                try {
                    const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lon}&current=temperature_2m,weather_code&timezone=auto`);
                    const data = await response.json();
                    
                    if (data.current) {
                        realTimeWeather.value = {
                            city: todayDay.city.split('/')[0],
                            temp: `${Math.round(data.current.temperature_2m)}Â°C`,
                            weather: getWeatherDesc(data.current.weather_code)
                        };
                    }
                } catch (e) {
                    console.error("å¤©æ°£æŠ“å–å¤±æ•—", e);
                }
            }

            // ğŸ”¥ æ–°å¢ï¼šç·šä¸Šäººæ•¸çµ±è¨ˆé‚è¼¯
            function initPresence() {
                const connectedRef = db.ref('.info/connected');
                const onlineRef = db.ref('presence');
                
                connectedRef.on('value', (snap) => {
                    if (snap.val() === true) {
                        const con = onlineRef.push();
                        con.onDisconnect().remove();
                        con.set(true);
                    }
                });

                onlineRef.on('value', (snap) => {
                    onlineCount.value = snap.numChildren();
                });
            }

            // ğŸ”¥ æ–°å¢ï¼šæŠ“å–ä½¿ç”¨è€…ä½ç½®å¤©æ°£ (å«æ‰‹å‹•/è‡ªå‹•åˆ‡æ› & çœŸå¯¦åŸå¸‚åç¨±)
            function initLocalWeather() {
                // ç›£è½å·¥ç¨‹ç‰ˆçš„è¨­å®š
                db.ref('systemSettings').on('value', (snapshot) => {
                    const settings = snapshot.val() || {};
                    const mode = settings.weatherMode || 'auto'; 
                    
                    if (mode === 'manual' && settings.manualData) {
                        localWeather.value = settings.manualData;
                    } else {
                        fetchUserLocationWeather();
                    }
                });
            }

            function fetchUserLocationWeather() {
                if (!navigator.geolocation) return;
                navigator.geolocation.getCurrentPosition(async (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    
                    try {
                        // 1. æŠ“å–åŸå¸‚åç¨± (ä½¿ç”¨ BigDataCloud å…è²» API)
                        const cityRes = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=zh`);
                        const cityData = await cityRes.json();
                        // å˜—è©¦æŠ“å– åŸå¸‚ > å€åŸŸ > æˆ–ç›´æ¥é¡¯ç¤ºç›®å‰ä½ç½®
                        const cityName = cityData.city || cityData.locality || 'ç›®å‰ä½ç½®';

                        // 2. æŠ“å–å¤©æ°£ (Open-Meteo)
                        const weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code&timezone=auto`);
                        const weatherData = await weatherRes.json();

                        if(weatherData.current) {
                            localWeather.value = {
                                city:cityName, 
                                temp: `${Math.round(weatherData.current.temperature_2m)}Â°C`,
                                weather: getWeatherDesc(weatherData.current.weather_code)
                            };
                        }
                    } catch(e) { 
                        console.error("å®šä½å¤©æ°£æŠ“å–å¤±æ•—", e); 
                    }
                });
            }

            onMounted(() => {
                initPresence(); // å•Ÿå‹•äººæ•¸çµ±è¨ˆ
                initLocalWeather(); // å•Ÿå‹•å¤©æ°£ç›£è½

                db.ref('tripData').on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        schedule.value = data.schedule || [];
                        expenses.value = data.expenses || [];
                        wishlist.value = data.wishlist || [];
                    } else {
                        syncToCloud(true);
                    }
                    dbStatus.value = "å·²é€£ç·š";
                    fetchRealTimeWeather();
                    
                }, () => dbStatus.value = "é€£ç·šå¤±æ•—");
            });

            const syncToCloud = (init = false) => {
                const data = {
                    schedule: init ? FIXED_SCHEDULE : JSON.parse(JSON.stringify(schedule.value)),
                    expenses: JSON.parse(JSON.stringify(expenses.value)),
                    wishlist: JSON.parse(JSON.stringify(wishlist.value))
                };
                if(init) schedule.value = FIXED_SCHEDULE;
                db.ref('tripData').set(data);
            };

            function getComparableDate(dateString) {
                const [month, day] = dateString.split('/').map(Number);
                let year = month === 1 ? 2026 : 2025;
                return new Date(year, month - 1, day);
            }

            const orderedSchedule = computed(() => {
                const today = new Date().setHours(0,0,0,0);
                return [...schedule.value].sort((a, b) => getComparableDate(a.date) - getComparableDate(b.date)).map(day => {
                    const d = getComparableDate(day.date).setHours(0,0,0,0);
                    return { ...day, isToday: d === today };
                });
            });

            const shouldShowDay = (dateStr) => {
                if (dateStr.startsWith('12/')) {
                    return showEarlyTrip.value;
                }
                return true; 
            };

            const todayHeaderWeather = computed(() => {
                if (realTimeWeather.value) {
                    return realTimeWeather.value;
                }
                const todayDay = orderedSchedule.value.find(day => day.isToday);
                return todayDay ? { city: todayDay.city.split('/')[0], weather: todayDay.weather, temp: todayDay.temp } : null;
            });

            const uniqueAccommodationNotes = computed(() => [...new Set(schedule.value.map(d => d.accommodation_note).filter(n => n && n !== 'N/A'))]);

            function getWeatherIcon(w) { 
                if (w?.includes('æ™´')) return 'fa-sun'; 
                if (w?.includes('é›¨') || w?.includes('æ·‹')) return 'fa-cloud-rain';
                if (w?.includes('é›·')) return 'fa-bolt';
                if (w?.includes('éœ§')) return 'fa-smog';
                return 'fa-cloud'; 
            }
            
            function getCategoryLabel(c) { return c; }
            function convertToTWD(a, c) { return (Number(a)||0) * (c === 'RMB' ? 4.4 : (c === 'HKD' ? 4.0 : 1)); }

           function showDetails(day) {
                selectedDayDetails.value = day;
                editBuffer.value = JSON.parse(JSON.stringify(day));
                
                // ğŸ”¥ ä¿®æ”¹ï¼šåŠ å…¥ (day.details || []) é˜²å‘†æ©Ÿåˆ¶
                // å¦‚æœ details æ˜¯ç©ºçš„ï¼Œå°±çµ¦å®ƒä¸€å€‹ç©ºé™£åˆ—ï¼Œé˜²æ­¢ç¨‹å¼å´©æ½°
                const safeDetails = day.details || [];
                
                detailsString.value = safeDetails.map(d => {
                    let str = d.time ? `${d.time}|${d.name}` : d.name;
                    if (d.note) str += `|${d.note}`;
                    return str;
                }).join('\n');
                
                isDetailModalOpen.value = true;
                isEditMode.value = false;
            }
            function closeModal() { isDetailModalOpen.value = false; isEditMode.value = false; }
            function startEdit() { isEditMode.value = true; }
            
            // ğŸ”¥ ä¿®æ”¹ï¼šå„²å­˜ç·¨è¼¯é‚è¼¯ï¼Œæ”¯æ´ |åˆ†éš”çš„å‚™è¨»
            function saveEdit() {
                const newDetails = detailsString.value.split('\n').filter(l => l.trim()).map(line => {
                    const parts = line.split('|');
                    // 1. ä¸‰æ®µå¼ï¼šæ™‚é–“|äº‹é …|å‚™è¨»
                    if (parts.length === 3) {
                        return { time: parts[0].trim(), name: parts[1].trim(), note: parts[2].trim() };
                    } 
                    // 2. å…©æ®µå¼ï¼šæ™‚é–“|äº‹é … (é è¨­)
                    else if (parts.length === 2) {
                        return { time: parts[0].trim(), name: parts[1].trim() };
                    } 
                    // 3. ä¸€æ®µå¼ï¼šäº‹é … (ç„¡æ™‚é–“)
                    else {
                        return { name: line.trim() };
                    }
                });
                
                const idx = schedule.value.findIndex(d => d.id === editBuffer.value.id);
                if (idx !== -1) {
                    schedule.value[idx] = { ...editBuffer.value, details: newDetails };
                    selectedDayDetails.value = schedule.value[idx];
                    syncToCloud();
                    isEditMode.value = false;
                }
            }

            function addExpense() { 
                if (newExpense.value.amount) { 
                    expenses.value.unshift({ 
                        ...newExpense.value, 
                        id: Date.now(), 
                        isEditing: false, 
                        item: newExpense.value.item || newExpense.value.category 
                    }); 
                    newExpense.value.amount = null; 
                    newExpense.value.item = ''; 
                    syncToCloud(); 
                } 
            }

            function deleteExpense(id) { expenses.value = expenses.value.filter(e => e.id !== id); syncToCloud(); }
            function toggleEdit(item) { item.isEditing = !item.isEditing; if(!item.isEditing) syncToCloud(); } 
            function addWishItem() { if (newWishItem.value.item) { wishlist.value.push({ ...newWishItem.value, id: Date.now(), done: false }); newWishItem.value.item = ''; syncToCloud(); } }
            function deleteWishItem(id) { wishlist.value = wishlist.value.filter(i => i.id !== id); syncToCloud(); }
            
            const calculatedTWD = computed(() => convertToTWD(calculator.value.amount, calculator.value.currency));
            const totalExpenseTWD = computed(() => expenses.value.reduce((acc, exp) => acc + convertToTWD(exp.amount, exp.currency), 0));
            const categoryTotals = computed(() => {
                const t = { 'åƒå–': 0, 'äº¤é€š': 0, 'è³¼ç‰©': 0, 'é–€ç¥¨': 0, 'å…¶ä»–': 0 };
                expenses.value.forEach(e => t[e.category] += convertToTWD(e.amount, e.currency));
                return t;
            });
            const filteredWishlist = computed(() => selectedMember.value === 'å…¨éƒ¨' ? wishlist.value : wishlist.value.filter(i => i.member === selectedMember.value));

            let expenseChartInstance = null;
            function renderChart() {
                if (expenseChartInstance) expenseChartInstance.destroy();
                const ctx = document.getElementById('expenseChart').getContext('2d');
                expenseChartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(categoryTotals.value).filter(k=>categoryTotals.value[k]>0), datasets: [{ data: Object.values(categoryTotals.value).filter(v=>v>0), backgroundColor: ['#FF6384', '#36A2EB', '#FFCD56', '#4BC0C0', '#9966FF'] }] } });
            }
            function openStatsModal() { isStatsModalOpen.value = true; nextTick(() => renderChart()); }

            return { 
                currentTab, essentialsMode, isStatsModalOpen, isDetailModalOpen, isEditMode, selectedDayDetails, dbStatus,
                currentTime, currentFullDate, todayHeaderWeather, orderedSchedule, appList, uniqueAccommodationNotes,
                expenses, newExpense, totalExpenseTWD, categoryTotals, wishlist, members, selectedMember, newWishItem, calculator, calculatedTWD,
                editBuffer, detailsString,
                showDetails, closeModal, startEdit, saveEdit, syncToCloud,
                addExpense, deleteExpense, toggleEdit, addWishItem, deleteWishItem, openStatsModal,
                getWeatherIcon, getCategoryLabel, convertToTWD, filteredWishlist,
                showEarlyTrip, shouldShowDay,
                onlineCount, localWeather // ğŸ”¥ ç¢ºä¿å›å‚³é€™äº›è®Šæ•¸
            };
        }
    }).mount('#app');
</script>
</body>

</html>

